#include <stdlib.h>
#include <stdio.h>
#include <string.h>

void packages();
void dataCleaning();
void queryByProduct();
void main(){
    packages();
    dataCleaning();
    queryByProduct();

}

void packages(){
    system("dpkg -p | tee packages.txt");
}


//This function will write the package and version of each package into a different file
void dataCleaning(){
    char bufferin[256], bufferout[256];
    FILE* fptr;
    fptr = fopen("packages.txt","r");
    FILE* wptr;
    wptr = fopen("output.txt","w");

    while(fgets(bufferin,sizeof(bufferin),fptr)){
        if(strstr(bufferin,"Package:") != NULL){
             strncpy(bufferout,bufferin+9,sizeof(bufferin) -7);
            bufferout[sizeof(bufferin)-9]='\0';
             fprintf(wptr, "%s", bufferout);

        }

        else if(strstr(bufferin,"Version:")!= NULL){
            strncpy(bufferout,bufferin+9,sizeof(bufferin) -6);
            bufferout[sizeof(bufferin)-9]='\0';
             fprintf(wptr, "%s", bufferout);
        }
            //fwrite

    }

    fclose(wptr);
    fclose(fptr);
}

void queryByProduct(){
    FILE* rptr;
    //FILE* wptr;
    rptr = fopen("output.txt", "r");
    //wptr = fopen("queryByProduct.txt","w");
    int index = 0;
    char bufferin[256], bufferout[256];

    while(fgets(bufferin,sizeof(bufferin),rptr)){
        if(index%2 == 0){
            strcpy(bufferout,"curl -X \'GET\' http://localhost:5000/api/search-product/");
            strcat(bufferout,bufferin);
            //strcat(bufferout, " \'accept: application/json\' | tee -a response.txt");
            strcat(bufferout, "\ | tee response.txt");
	    system(bufferout);
        }
        index++;
    }
    fclose(rptr);
    //fclose(wptr);
}
