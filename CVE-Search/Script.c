#include <stdlib.h>
#include <stdio.h>
#include <string.h>

void packages();
void dataCleaning();
void queryByProduct();
void queryByVersion();
void queryByVersionProduct();

void main(){
    //packages();
    //dataCleaning();
	queryByProduct();
	queryByVersion();
	queryByVersionProduct();
}

void packages(){
    system("dpkg -p | tee packages.txt");
}


//This function will write the package and version of each package into a different file
void dataCleaning(){
    char bufferin[256], bufferout[256];
    FILE* fptr;
    fptr = fopen("packages.txt","r");
    FILE* wptr;
    wptr = fopen("output.txt","w");

    while(fgets(bufferin,sizeof(bufferin),fptr)){
        if(strstr(bufferin,"Package:") != NULL){
             strncpy(bufferout,bufferin+9,sizeof(bufferin) -7);
            bufferout[sizeof(bufferin)-9]='\0';
             fprintf(wptr, "%s", bufferout);

        }

        else if(strstr(bufferin,"Version:")!= NULL){
            strncpy(bufferout,bufferin+9,sizeof(bufferin) -6);
            bufferout[sizeof(bufferin)-9]='\0';
             fprintf(wptr, "%s", bufferout);
        }
            //fwrite

    }

    fclose(wptr);
    fclose(fptr);
}

void queryByVersionProduct(){
	FILE* rptr;
	rptr = fopen("output.txt","r");
	int index = 0;
	char bufferin[256],bufferout[256];

	while(fgets(bufferin,sizeof(bufferin),rptr)){
		if(index%2 ==0){
			bufferin[strcspn(bufferin,"\n")]='\0';
			strcpy(bufferout, "curl localhost:5000/api/search-vendor/ven/");
			strcat(bufferout,bufferin);
			strcat(bufferout, " | tee -a queryByVersionProduct.txt");
			system(bufferout);
		}
		index++;
	}
	fclose(rptr);
}

void queryByVersion(){
	FILE* rptr;
	rptr = fopen("output.txt","r");
	int index = 0;
	char bufferin[256],bufferout[256];

	while (fgets(bufferin,sizeof(bufferin),rptr)){
		if(index%2==0){
			strcpy(bufferout,"curl http://localhost:5000/api/search-vendor/ven/");
			bufferin[strcspn(bufferin,"\n")]='\0';
			strcat(bufferout,bufferin);
		}	
		else{
			strcat(bufferout,"/");
			bufferin[strcspn(bufferin,"\n")]='\0';
			strcat(bufferout,bufferin);
			strcat(bufferout, " | tee -a response.txt");
			system(bufferout);
		}
		index++;
	}
	fclose(rptr);
}

void queryByProduct() {
    FILE* rptr;
    rptr = fopen("output.txt", "r");
    int index = 0;
    char bufferin[256], bufferout[512]; // Increased buffer size to accommodate longer command

    while (fgets(bufferin, sizeof(bufferin), rptr)) {
        if (index % 2 == 0) {
            // Construct the curl command with output redirection
	    bufferin[strcspn(bufferin,"\n")]='\0';
            snprintf(bufferout, sizeof(bufferout),
                "curl http://localhost:5000/api/search-product/%s | tee -a queryByProduct.txt",
                bufferin);

            // Execute the curl command
            system(bufferout);
        }
        index++;
    }

    fclose(rptr);
}

